<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>{{client?.name}}</ion-title>
    <ion-progress-bar
      [hidden]="hideSkeletonText"
      type="indeterminate"
    ></ion-progress-bar>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="bgLight p-2 rounded text-center mx-2 mt-2">
    Current transactions
  </div>

  <ion-accordion-group
    class="m-2 text-center d-flex flex-wrap justify-content-evenly"
  >
    <div
      *ngFor="let data of client?.data; let i=index; trackBy:trackData"
      class="my-1 listItem text-start"
    >
      <ion-accordion [value]="i">
        <ion-item slot="header" class="rounded" color="light">
          <input
            type="checkbox"
            (click)="onCheckBoxClick($event, data)"
            [checked]="getChipColor(data?.id)"
            class="form-check-input"
            [attr.data-bs-theme]="theme"
            [disabled]="data?.closedOn"
          />
          <ion-label class="d-flex ms-2" color="{{getColor(data)}}">
            <span class="fw-bolder">₹ {{ isd.format(data?.principal) }}</span>
            <span class="ms-auto fw-bolder"
              >{{data?.startDate | date : "dd/MM/YYYY"}}</span
            ></ion-label
          >
        </ion-item>
        <ion-list slot="content" lines="none" class="rounded mx-auto">
          <div class="bgLight mx-2 ps-2 rounded fw-bold py-1">
            <ion-grid>
              <ion-row>
                <ion-col size="5">Principal</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">₹ {{isd.format(data?.principal)}}</ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="5">Interest</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">{{data?.interest}}</ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="5">Start date</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">
                  {{data?.startDate | date : "dd/MM/YYYY"}}
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="5">End date</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5"> {{today| date : "dd/MM/YYYY"}} </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div class="bgLight m-2 rounded ps-2 py-1 fw-bold">
            <ion-grid>
              <ion-row>
                <ion-col size="5">Time period</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">
                  {{calculateDateDifference(data?.startDate,today)}}
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="5">in months</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5"
                  >{{totalTimeinMonths(data?.startDate,today)}}m</ion-col
                >
              </ion-row>
              <ion-row>
                <ion-col size="5">Interest amt</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">
                  ₹ {{isd.format(calculateInterest(data, today))}}
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="5">Total amt</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">
                  ₹ {{isd.format(data?.principal +
                  calculateInterest(data,today))}}
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div *ngIf="data?.comments" class="bgLight p-2 rounded mx-2 mb-2">
            <small class="fw-bold d-block">Comments : </small>
            <small style="white-space: pre-line">{{data?.comments}}</small>
          </div>

          <div
            *ngIf="data?.closedOn"
            class="bgLight mb-2 mx-2 rounded ps-2 py-1 fw-bold border-success border-3 border"
          >
            <ion-grid>
              <ion-row>
                <ion-col size="5">Closed on</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">
                  {{data?.closedOn | date : "dd/MM/YYYY"}}
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col size="5">Paid amt</ion-col>
                <ion-col size="2">:</ion-col>
                <ion-col size="5">
                  ₹ {{isd.format(data?.closedAmount)}}
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>

          <div
            *ngIf="totalTimeinMonths(data?.startDate,today)>36"
            class="d-flex m-2 py-1 justify-content-around align-items-center bgWarning rounded"
          >
            <ion-icon name="alert" size="large" slot="start"></ion-icon>
            <div>
              Interest calculated for 3 years only.<br />
              Please use calculate option.
            </div>
          </div>

          <div class="bgLight rounded m-2">
            <ion-grid>
              <ion-row>
                <ion-col>
                  <ion-button
                    color="primary"
                    expand="block"
                    (click)="editClientData(data?.id)"
                    >Edit</ion-button
                  >
                </ion-col>
                <ion-col>
                  <ion-button
                    color="warning"
                    expand="block"
                    (click)="openCalculator(data?.id)"
                    >Calculate</ion-button
                  >
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>
                  <ion-button
                    color="success"
                    expand="block"
                    [id]="'approveScreen'+i"
                    [disabled]="data?.closedOn"
                    >Approve</ion-button
                  >
                </ion-col>
                <ion-col>
                  <ion-button
                    color="danger"
                    expand="block"
                    (click)="deleteData(data?.id)"
                    >Delete</ion-button
                  >
                </ion-col>
              </ion-row>
            </ion-grid>
          </div>
        </ion-list>
      </ion-accordion>

      <ion-modal
        #modal
        [trigger]="'approveScreen'+i"
        [initialBreakpoint]="1"
        [breakpoints]="[1]"
      >
        <ng-template>
          <app-approve-modal
            [data]="data"
            [client]="client"
          ></app-approve-modal>
        </ng-template>
      </ion-modal>
    </div>
  </ion-accordion-group>

  <ion-item
    color="light"
    class="rounded text-center m-2"
    routerLink="/clida/clients-list/add-client"
    [queryParams]="{name:client?.name}"
    ><ion-label class="text-danger fw-bolder"> + Add new record </ion-label>
  </ion-item>

  <div class="text-center">
    <ion-chip (click)="toggleTotalChips()">
      Total amount: ₹ {{isd.format(totalAmount)}}
    </ion-chip>
  </div>

  <div class="m-2" style="font-size: 90%" *ngIf="selectedChips.length">
    <table
      class="table table-sm table-striped rounded overflow-hidden"
      [attr.data-bs-theme]="theme"
    >
      <thead>
        <tr>
          <th>Principal</th>
          <th>Interest</th>
          <th>P + I</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let record of selectedChips">
          <td>₹ {{isd.format(record.principal)}}</td>
          <td>₹ {{isd.format(record.interest)}}</td>
          <td>₹ {{isd.format(record.principal + record.interest)}}</td>
        </tr>
        <tr>
          <td></td>
          <td>Total amount</td>
          <th>{{getTotalSelectedAmount()}}</th>
        </tr>
      </tbody>
    </table>
  </div>
</ion-content>
