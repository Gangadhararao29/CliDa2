<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
    </ion-buttons>
    <ion-title>{{client?.name}}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="mx-2 mt-1">
    <div [hidden]="hideSkeletonText" class="mx-2">
      <ion-progress-bar type="indeterminate"></ion-progress-bar>
    </div>

    <ion-accordion toggle-icon="none" readonly="true">
      <ion-item slot="header" color="primary" class="rounded-1">
        <ion-label class="d-flex ms-2">
          <span class="fw-bolder">Principal</span>
          <span class="ms-auto fw-bolder">Start date</span>
        </ion-label>
      </ion-item>
    </ion-accordion>

    <ion-accordion-group class="my-2">
      <div *ngFor="let data of client?.data; let i=index;" class="mt-2">
        <ion-accordion [value]="i">
          <ion-item slot="header" [color]="getColor(data)" class="rounded-3">
            <ion-label class="d-flex ms-2">
              <span class="fw-bolder">₹ {{ isd.format(data?.principal) }}</span>
              <span class="ms-auto fw-bolder"
                >{{data?.startDate.split('-').reverse().join('/')}}</span
              ></ion-label
            >
          </ion-item>
          <ion-list slot="content" class="rounded-3">
            <div class="bgLight px-3 py-2 rounded-3 mt-0 mx-1">
              <div class="row fw-bolder">
                <div class="col-5">Principal</div>
                <div class="col-2">:</div>
                <div class="col-5">₹ {{isd.format(data?.principal)}}</div>
              </div>
              <div class="row fw-bolder">
                <div class="col-5">Interest</div>
                <div class="col-2">:</div>
                <div class="col-5">{{data?.interest}}</div>
              </div>
              <div class="row fw-bolder">
                <div class="col-5">Start date</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  {{data?.startDate.split('-').reverse().join('/')}}
                </div>
              </div>
              <div class="row fw-bolder">
                <div class="col-5">End date</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  {{today.split('-').reverse().join('/')}}
                </div>
              </div>
            </div>

            <div class="bgLight px-3 py-2 rounded-3 mt-2 mx-1">
              <div class="row fw-bolder">
                <div class="col-5">Time period</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  {{calculateDateDifference(data?.startDate,today)}}
                </div>
              </div>

              <div class="row fw-bolder">
                <div class="col-5">in months</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  {{totalTimeinMonths(data?.startDate,today).toFixed(2)}}m
                </div>
              </div>
              <div class="row fw-bolder">
                <div class="col-5">Interest amt</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  ₹ {{isd.format(calculateInterest(data, today))}}
                </div>
              </div>
              <div class="row fw-bolder">
                <div class="col-5">Total amt</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  ₹ {{isd.format(data?.principal + calculateInterest(data,
                  today))}}
                </div>
              </div>
            </div>

            <div
              *ngIf="data?.comments"
              class="bgLight p-2 rounded-3 mt-2 mx-1 align-items-center"
            >
              <small class="fw-bolder d-block">Comments : </small>
              <small style="white-space: pre-line">{{data?.comments}}</small>
            </div>

            <div
              *ngIf="data?.closedOn"
              class="bgLight px-3 py-2 rounded-3 mt-2 mx-1 border-success border-3 border"
            >
              <div class="row fw-bolder">
                <div class="col-5">Closed on</div>
                <div class="col-2">:</div>
                <div class="col-5">
                  {{data?.closedOn.split('-').reverse().join('/')}}
                </div>
              </div>

              <div class="row fw-bolder">
                <div class="col-5">Paid amt</div>
                <div class="col-2">:</div>
                <div class="col-5">₹ {{isd.format(data?.closedAmount)}}</div>
              </div>
            </div>

            <div
              *ngIf="totalTimeinMonths(data?.startDate,today)>36"
              class="d-flex mt-2 mx-1 p-1 justify-content-around align-items-center bg-warning rounded-3"
            >
              <ion-icon
                name="alert-circle-outline"
                size="large"
                slot="start"
              ></ion-icon>
              <div>
                Interest calculated for 3 years only.<br />
                Please use calculate option.
              </div>
            </div>

            <div class="bgLight rounded-3 mt-2 mx-1">
              <ion-grid>
                <ion-row>
                  <ion-col>
                    <ion-button
                      color="primary"
                      expand="block"
                      (click)="editClientData(data?.id)"
                      >Edit</ion-button
                    >
                  </ion-col>
                  <ion-col>
                    <ion-button
                      color="warning"
                      expand="block"
                      (click)="openCalculator(data?.id)"
                      >Calculate</ion-button
                    >
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col>
                    <ion-button
                      color="success"
                      expand="block"
                      [id]="'approveScreen'+i"
                      (click)="approveData(data)"
                      [disabled]="data?.closedOn"
                      >Approve</ion-button
                    >
                  </ion-col>
                  <ion-col>
                    <ion-button
                      color="danger"
                      expand="block"
                      (click)="deleteData(data?.id)"
                      >Delete</ion-button
                    >
                  </ion-col>
                </ion-row>
              </ion-grid>
            </div>
          </ion-list>
        </ion-accordion>

        <ion-modal
          #modal
          [trigger]="'approveScreen'+i"
          [initialBreakpoint]="0.4"
          [breakpoints]="[0, 0.4, 0.6, 0.8]"
        >
          <ng-template>
            <ion-content>
              <form
                #formRef="ngForm"
                (ngSubmit)="onSubmit(formRef)"
                (keypress)="stopDefaultSubmit($event)"
              >
                <div class="mx-1 mt-3 px-2 pt-2 rounded-3 bgLight">
                  <div class="fw-bolder mx-1 mb-1">Enter closed details</div>
                  <div class="d-flex">
                    <div class="form-floating">
                      <input
                        type="date"
                        class="form-control"
                        id="closedOn"
                        [ngModel]="today"
                        (change)="onchangeClosedDetails($event,data)"
                        #closedOn="ngModel"
                        name="closedOn"
                        required
                        [class.is-valid]="closedOn.valid"
                        [class.is-invalid]="closedOn.invalid &&  formRef.submitted"
                      />
                      <label for="closedOn">On</label>
                      <div id="closedOn" class="invalid-feedback">
                        Please enter On-date.
                      </div>
                    </div>
                    <!-- getClosedAmount2(data,closedOn) -->
                    <div class="form-floating">
                      <input
                        type="number"
                        class="form-control"
                        id="closedAmount"
                        [ngModel]="data?.principal + calculateInterest(data,today)"
                        name="closedAmount"
                        (input)="onchangeClosedDetails($event,data,closedOn)"
                        #closedAmount="ngModel"
                        required
                        [class.is-valid]="closedAmount.valid"
                        [class.is-invalid]="closedAmount.invalid &&  formRef.submitted"
                      />
                      <label for="closedAmount">Amount</label>
                      <div id="closedAmount" class="invalid-feedback">
                        Please enter Amount.
                      </div>
                    </div>
                  </div>

                  <div
                    [hidden]="approvedAmount===0"
                    class="text-danger mx-1 bgLight"
                  >
                    <small
                      >**Required amount is ₹
                      {{isd.format(approvedAmount)}}</small
                    >
                  </div>

                  <div
                    class="form-check form-switch m-1"
                    [hidden]="hideAppprovedControls"
                  >
                    <label class="form-check-label" for="updateComments">
                      Auto update comments
                    </label>
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="updateComments"
                      name="updateComments"
                      [ngModel]="true"
                      ngModel
                    />
                  </div>

                  <div
                    class="form-check form-switch m-1"
                    [hidden]="hideAppprovedControls"
                  >
                    <label class="form-check-label" for="closeCurrentRecord">
                      Close current record
                    </label>
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="closeCurrentRecord"
                      name="closeCurrentRecord"
                      [ngModel]="false"
                      #closeCurrentRecord="ngModel"
                    />
                  </div>

                  <div
                    class="form-check form-switch m-1"
                    [hidden]="hideAppprovedControls"
                  >
                    <label class="form-check-label" for="addNewRecord">
                      Add new record with remaining balance
                    </label>
                    <input
                      class="form-check-input"
                      type="checkbox"
                      id="addNewRecord"
                      name="addNewRecord"
                      [ngModel]="false"
                      ngModel
                      [disabled]="!closeCurrentRecord.value"
                    />
                  </div>
                </div>

                <ion-button
                  class="mx-1 my-2"
                  type="submit"
                  color="success"
                  [disabled]="data?.closedOn"
                  (click)="modal.dismiss()"
                  expand="block"
                >
                  close record
                </ion-button>
                <ion-button
                  class="mx-1 my-2"
                  color="warning"
                  (click)="modal.dismiss()"
                  expand="block"
                >
                  Cancel
                </ion-button>
              </form>
            </ion-content>
          </ng-template>
        </ion-modal>
      </div>
    </ion-accordion-group>

    <ion-item
      color="light"
      class="rounded-3 text-center mb-2"
      routerLink="/clida/clients-list/add-client"
      ><ion-label class="text-danger fw-bolder"
        >+ Add new record</ion-label
      ></ion-item
    >
  </div>
</ion-content>
